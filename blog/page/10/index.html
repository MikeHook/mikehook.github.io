
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>baking websites</title>
	<meta name="author" content="Hook Technologies Ltd">

	
	<meta name="description" content="Nov 16th, 2009 Hacking Comments Integrating the TinyMCE Rich Text Editor I ve been working on a page to add method descriptions for the recipes. The &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="baking websites" type="application/atom+xml">
	
	<link rel="canonical" href="http://bakingwebsites.co.uk/blog/page/10/">
	<link href="http://bakingwebsites.co.uk/favicon.png" rel="shortcut icon">
	<link href="http://bakingwebsites.co.uk/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="http://bakingwebsites.co.uk/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> 
-->
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700" rel="stylesheet" type="text/css">

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47738964-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<img src="/images/bread-Sq-zoom-150.jpg" alt="Profile Picture" style="width: 160px;" />
</div>
<hgroup>
  <h1><a href="http://bakingwebsites.co.uk/">baking websites</a></h1>
  
    <h2>adventures in software development</h2>
  
</hgroup>

<nav id="main-nav"><h3>categories</h3>
<ul class="main-navigation">
<li class='category'><a href='/blog/categories/hacking/'>Hacking</a>[ 22 ]</li>
<li class='category'><a href='/blog/categories/progress/'>Progress</a>[ 7 ]</li>
<li class='category'><a href='/blog/categories/software-design/'>Software Design</a>[ 16 ]</li>
<li class='category'><a href='/blog/categories/testing/'>Testing</a>[ 2 ]</li>
<li class='category'><a href='/blog/categories/tips-and-tricks/'>Tips and Tricks</a>[ 9 ]</li>

</ul>
<br/>
<a href="http://bakingwebsites.co.uk/blog/archives">Archives</a>


</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
			<a class="twitter" href="http://twitter.com/michael_hook" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/MikeHook" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2009-11-16T20:45:00+00:00" data-updated="true" itemprop="datePublished">Nov 16<span>th</span>, 2009</time></div>
		<div class="tags">


	<a class='category' href='http://bakingwebsites.co.uk/blog/categories/hacking/'>Hacking</a>


</div>
		
			<span class="comments"><a href="http://bakingwebsites.co.uk/2009/11/16/integrating-the-tinymce-rich-text-editor/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="http://bakingwebsites.co.uk/2009/11/16/integrating-the-tinymce-rich-text-editor/" itemprop="url">Integrating the TinyMCE Rich Text Editor</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I   ve been working on a page to add method descriptions for the recipes. The most simple solution for this would be a large text area allowing the user to add multiple lines of text for the recipe method. However I think this would be too limiting for the users and also offer poor formatting when the completed recipes are viewed. A better solution is to use a rich text editor which allows users to entered formatted text and generates HTML to use on the recipe views.</p>

<p>The editor had to allow the users to enter formatted text including paragraphs, text highlighting, numbered and bulleted lists. It was also important that the editor could be limited to prevent users entering content which would break the styling of the site. For example no image tags should be entered in the method as there is already a separate image property for each recipe. Fortunately I   ve had experience using the <a href="http://tinymce.moxiecode.com/">TinyMCE rich text editor</a> from working on <a href="http://n2cms.com/">N2 CMS</a> based websites at work and this editor meets all of the requirements.</p>

<p>Integrating TinyMCE into the site was pretty straightforward, there is detailed documentation on the <a href="http://wiki.moxiecode.com/">TinyMCE wiki</a>, including installation instructions. Adding the editor to the site is simply a case of downloading the assets, including them in the VS project and including a javascript call to load the editor in the page header. By default the call transforms all text areas into TinyMCE editors. I also found the simple mode provided the limited feature set I was looking for. There were just a couple of issues to resolve before the editor could be used.</p>

<h4>Disable Input Validation</h4>


<p>The editor generates HTML which is posted back to the server when the page is submitted. However by default MVC throws an exception as the postback contains HTML tags:</p>

<blockquote><strong>Exception Details: </strong>System.Web.HttpRequestValidationException: A potentially dangerous Request.Form value was detected from the client (CookingMethod=&#8221;&lt;p&gt;A Test method&lt;/p&gt;
&lt;u&#8230;&#8221;).</blockquote>


<p>To prevent this exception from being thrown the page validation must be disabled. This is done by adding the <em>[ValidateInput(false)]</em> attribute to the controllers action method which is called when the page is submitted.</p>

<h4>Protect Against Unwanted HTML / XSS</h4>


<p>After making this change the editor content posts back to the server and can be saved to the repository. However disabling the input validation leaves the site open to cross site scripting (XSS) attacks so some extra precautions need to be put in place.
TinyMCE already checks the content which is posted back, however the wiki points out that the editor can be easily disabled by any user by disabling javascript in the browser. They recommend that some server side checks are put in place to prevent any unwanted tags and scripts from being persisted to the repository.
I   ve added some code to check the recipe method string and strip all unwanted tags. It uses a regular expression to allow a subset of tags to be saved. Any other tags are replaced by an empty string. I found a good <a href="http://stackoverflow.com/questions/307013/how-do-i-filter-all-html-tags-except-a-certain-whitelist">SantizeHTML method</a> posted on stack overflow, so no need to reinvent the wheel here!</p>

<h4>Protect Against CSRF</h4>


<p>While I was in the area of security I thought I may as well increase the protection of the form to cross site request forgery (CSRF) attacks. Steve Sanderson has already written a full <a href="http://blog.codeville.net/2008/09/01/prevent-cross-site-request-forgery-csrf-using-aspnet-mvcs-antiforgerytoken-helper/">blog post</a> on this subject (among others I   m sure) so I won   t go into detail on this. Suffice to say I thought it was worth adding as it only takes 5 minutes and provides an extra level of protection which may be needed later.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2009-10-16T13:55:00+01:00" data-updated="true" itemprop="datePublished">Oct 16<span>th</span>, 2009</time></div>
		<div class="tags">


	<a class='category' href='http://bakingwebsites.co.uk/blog/categories/software-design/'>Software Design</a>


</div>
		
			<span class="comments"><a href="http://bakingwebsites.co.uk/2009/10/16/optimising-data-access-queries-part-2/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="http://bakingwebsites.co.uk/2009/10/16/optimising-data-access-queries-part-2/" itemprop="url">Optimising Data Access Queries (Part 2)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In <a href="http://www.blogger.com/2009/10/optimising-data-access-queries-part-1.html">part 1</a> of this post I implemented a custom repository method to find all ingredients containing a keyword. The obvious improvement for this query was to extend the search to multiple keywords. As usual the first step was to write a unit test for the new method:</p>

<pre style="border:1px dashed #999999;overflow:auto;background-color:#eeeeee;color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:236px;line-height:14px;width:114.97%;padding:5px;"><code>        protected override void LoadTestData()
        {
            CreatePersistedIngredient(1, "Chicken thigh", FoodGroup.Meat);
            CreatePersistedIngredient(2, "Chicken breast", FoodGroup.Meat);
            CreatePersistedIngredient(3, "Red Pepper", FoodGroup.Vegetable);
            CreatePersistedIngredient(4, "Jalapeno Chilli", FoodGroup.Vegetable);
        }

        [Test]
        public void CanFindIngredientsByKeywords()
        {
            List&lt;Ingredient&gt; ingredients = ingredientRepository.FindByKeywords(new string[] { "chilli", "pepper" }).ToList();
            ingredients.ShouldNotBeNull();
            ingredients.Count.ShouldEqual(2);
        }
</code></pre>


<p>The test expects 2 ingredients to be returned for the search     both the    Red pepper    and    Jalapeno Chilli    ingredients should be returned.</p>

<h4>Predicate functions and Expression trees</h4>


<p>I wanted to keep using the Linq-to-NHibernate library for the data access queries as this ensures that the queries inherit all the <a href="http://weblogs.asp.net/scottgu/archive/2006/05/14/Using-LINQ-with-ASP.NET-_2800_Part-1_2900_.aspx">benefits of Linq</a>. I also find it more intuitive to use than HQL, for simple queries at least! The core problem was how to write a Linq query that could be extended for an arbitrary number of keywords. In HQL this could be achieved by looping over the keywords and building up the query string. However it is not so easy to iteratively build a lambda function.</p>

<p>My first effort involved chaining together <a href="http://www.codeproject.com/KB/cs/FunWithFunc1.aspx">predicate functions</a>. However after passing the chained predicate to NHibernate the rather less than impressive result was nothing    for any query! Looking at the SQL query produced showed that an incomplete statement was being passed without any of the filter keywords. I was unable to find any documentation to speak of for Linq-to-NHibernate but the <a href="http://groups.google.com/group/nhusers">NHibernate user group</a> did prove useful. They suggested that I may have more success building up an <a href="http://blogs.msdn.com/charlie/archive/2008/01/31/expression-tree-basics.aspx">expression tree</a> and using that as the predicate.
<a href="http://blogs.msdn.com/charlie/archive/2008/01/31/expression-tree-basics.aspx"></a></p>

<h4>Dynamic Linq-to-NHibernate Query</h4>


<p>After reading up on expression trees I was in a position to code up a method to dynamically build the predicate. While researching the best way to tackle this, the internet again reminded me that there are not many original problems left in this world! This article by Joseph Albahari on  <a href="http://www.albahari.com/nutshell/predicatebuilder.aspx">dynamically composing expression predicates</a> demonstrated how a helper class could be used to farm out the work of building up the predicate. The following class makes use of the PredicateBuilder class provided in the article:</p>

<pre style="border:1px dashed #999999;overflow:auto;background-color:#eeeeee;color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:180px;line-height:14px;width:114.82%;padding:5px;"><code>        public IEnumerable&lt;Ingredient&gt; FindByKeywords(IEnumerable&lt;string&gt; keywords)
        {
            Expression&lt;Func&lt;Ingredient, bool&gt;&gt; predicate = PredicateBuilder.False&lt;Ingredient&gt;();

            foreach (string keyword in keywords)
            {
                string temp = keyword;
                predicate = predicate.Or(i =&gt; i.Name.Contains(temp));
            }
            return Session.Linq&lt;Ingredient&gt;().Where(predicate);
        }
</code></pre>




<ul>
    <li> The expression predicate is initialised to false</li>
    <li>The predicate is chained together using the <em>Or</em> method of predicate builder class</li>
    <li>The final predicate will return true for any Ingredient that has a Name containing any of the keywords.</li>
</ul>


<p>The FindByKeywords method passes the unit test at the start of the post. Implementing this method took a while, mostly due to the time taken to read up on the predicate functions and expression trees. However I think it was time worth spending as these language features are here to stay and will most likely increase in use over time. Also I now have a handy way of writing efficient Linq queries with multiple filter parameters :)</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2009-10-11T16:11:00+01:00" data-updated="true" itemprop="datePublished">Oct 11<span>th</span>, 2009</time></div>
		<div class="tags">


	<a class='category' href='http://bakingwebsites.co.uk/blog/categories/software-design/'>Software Design</a>


</div>
		
			<span class="comments"><a href="http://bakingwebsites.co.uk/2009/10/11/optimising-data-access-queries-part-1/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="http://bakingwebsites.co.uk/2009/10/11/optimising-data-access-queries-part-1/" itemprop="url">Optimising Data Access Queries (Part 1)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I will be looking at the best way to re-factor a data access query which is used on the add ingredients page. Initially the query was written quickly with no consideration given to the time it would take to execute. It is not currently a problem as the database is very small but in future the page could be very slow to load.<br /></p>

<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:40px;line-height:14px;overflow:auto;width:100.55%;padding:5px;"><code>    ingredientsModel.MatchingIngredients = IngredientRepository.GetAll()
        .Where(i =&gt; i.Name.ToLower().Contains(ingredientsModel.SearchIngredient.ToLower())).ToList();
</code></pre>


<p>This is a poorly optimised query as the generic <a href="http://wiki.sharparchitecture.net/ClassLibraries.ashx#SharpArchData_2">Sharp Architecture repository</a> <i>GetAll()</i> method call retrieves the entire data set from the database. It is then filtered in memory to get the actual matching ingredients. For larger datasets, it would be much quicker if the data is filtered before it is retrieved from the database. The query could be rewritten to use the <i>FindAll(IDictionary propertyValuePairs)</i> method like this:<br /></p>

<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:32px;line-height:14px;overflow:auto;width:100.72%;padding:5px;"><code>    ingredientsModel.MatchingIngredients = IngredientRepository
        .FindAll(new Dictionary { { "Name", ingredientsModel.SearchIngredient.ToLower()} });</code></pre>


<p>This does solve the optimisation issue as the resulting database SQL query uses a <i>Where</i> clause to pre-filter the data. However, the query is limited to retrieving exact matches to the search string. It is unlikely that users will input the exact ingredient they are searching for, so it would be better if the query retrieved all ingredients that contain the search term. <br /></p>

<h4>
Unit Testing the Custom Repository</h4>


<p>In order to do this I will use a custom repository and add my own query method. Much credit is due to the <a href="http://wiki.sharparchitecture.net/SettingUpNorthwind.ashx">Sharp Architecture example projects</a>, which provide a good basis for the techniques I   ve used here. First, I&rsquo;ll write a unit test for the new repository method. The test class is shown below and each section is explained after the class: <br /></p>

<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:471px;line-height:14px;overflow:auto;width:100.88%;padding:5px;"><code>    [TestFixture]
    public class IngredientRepositoryTests : RepositoryTestsBase
    {
        protected override void LoadTestData()
        {
            CreatePersistedIngredient(1, "Chicken thigh", FoodGroup.Meat);
            CreatePersistedIngredient(2, "Chicken breast", FoodGroup.Meat);
            CreatePersistedIngredient(3, "Red Pepper", FoodGroup.Vegetable);
            CreatePersistedIngredient(4, "Jalapeno Chilli", FoodGroup.Vegetable);
        }

        private IIngredientRepository ingredientRepository = new IngredientRepository();

        private Ingredient CreatePersistedIngredient(int ingredientId, string ingredientName, FoodGroup foodGroup)
        {
            Ingredient ingredient = new Ingredient(ingredientName, foodGroup);
            ingredientRepository.SaveOrUpdate(ingredient);
            FlushSessionAndEvict(ingredient);
            return ingredient;
        }

        [Test]
        public void CanFindIngredientsByName()
        {
            List&lt;Ingredient&gt; ingredients = ingredientRepository.FindByName("chicken").ToList();
            ingredients.ShouldNotBeNull();
            ingredients.Count.ShouldEqual(2);
        }
    }
</code></pre>




<ul>
<li>The unit test inherits from the RepositoryTestsBase (namespace SharpArch.Testing.NUnit.NHibernate) which enables test data to be easily loaded into the in-memory database by overriding the the LoadTestData method. </li>
<li>The ingredientRepository property is the custom repository data access class </li>
<li>The CreatePersistedIngredient method is used in the LoadTestData method to save a single ingredient entity to the in-memory database. Note the call to FlushSessionAndEvict is used to persist the saved entity to the database </li>
<li>The CanFindIngredientsByName method is our test method which runs the repository FindByName method&nbsp; </li>
<li>The test method asserts that the ingredients list is populated with 2 Ingredient entities </li>
</ul>




<h4>
Implementing the Custom Repository </h4>


<p>Now we are ready to implement the custom repository for the accessing ingredient data. Again, the class is shown below with explanations following it: <br /></p>

<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:andale mono, lucida console, monaco, fixed, monospace;font-size:12px;height:110px;line-height:14px;overflow:auto;width:101.54%;padding:5px;"><code>    public class IngredientRepository : Repository&lt;Ingredient&gt;, IIngredientRepository
    {        
        public IEnumerable&lt;Ingredient&gt; FindByName(string ingredientName)
        {
            return Session.Linq&lt;Ingredient&gt;().Where(a =&gt; a.Name.Contains(ingredientName));
        }
    }
</code></pre>




<ul>
<li>The custom repository inherits from the generic sharp architecture Repository class, ensuring that all the standard access methods are available </li>
<li>It implements the IIngredientRepository interface. This enables IoC injection of the repository into the controllers. </li>
<li>The FindByName method implements a <a href="http://nhforge.org/">Linq to NHibernate</a> query using the <i>Where</i> method. This will be transformed into a SQL query using a <i>Where</i> clause to prefilter the data before it is retrieved. </li>
</ul>


<p>The custom repository method passes the unit test and returns the expected data. The original query is now optimised and will perform much better against larger data sets. I   ve improved the efficiency of the data access, however I   d also like to improve the functionality. So in the next post I will be looking at extending the ingredient repository with a new dynamic query. This will enable searching by an arbitrary number of keywords.<br /></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2009-09-14T08:45:00+01:00" data-updated="true" itemprop="datePublished">Sep 14<span>th</span>, 2009</time></div>
		<div class="tags">


	<a class='category' href='http://bakingwebsites.co.uk/blog/categories/hacking/'>Hacking</a>


</div>
		
			<span class="comments"><a href="http://bakingwebsites.co.uk/2009/09/14/custom-routing-for-the-recipe-controllers-mvc/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="http://bakingwebsites.co.uk/2009/09/14/custom-routing-for-the-recipe-controllers-mvc/" itemprop="url">Custom Routing for the Recipe Controllers (MVC)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;ve been working on re-factoring the add recipe feature to include a draft recipe domain object. However the recipe controller has been steadily expanding, along with the number of unit tests to support it. This was causing me issues as it was getting difficult to scan through the files to find the methods I&rsquo;m interested in. So I&rsquo;ve introduced some custom routing and split up the recipe controller.<br /></p>

<br />


<p><b>Original recipe controller signature </b><br />
This was the recipe controller signature before introducing the customer routing (for brevity in this post I&rsquo;ve extracted the controller signature to an interface, the interface is not actually used in the project):<br /></p>

<br />




<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;font-size:12px;line-height:14px;overflow:auto;width:100%;padding:5px;"><code>    interface IRecipesController
    {
        ActionResult Index(string title);

        ActionResult EditIngredients(string recipeTitle);
        ActionResult EditIngredients(RecipeIngredientsModel ingredientsModel);

        ActionResult EditMethod(string recipeTitle);
        ActionResult AddRecipeIngredient(RecipeIngredientsModel ingredientsModel);
        ActionResult SearchIngredients(RecipeIngredientsModel ingredientsModel);
        ActionResult EditMethod(RecipeMethodModel methodModel);

        ActionResult EditSummary(string recipeTitle);
        ActionResult EditSummary(RecipeSummaryModel summaryModel);   
    }
</code></pre>




<br />


<p>So that&rsquo;s 9 public methods, along with some private methods, taking the total up to around 15. I thought that was too many for the class to be easily manageable.<br /></p>

<br />


<p><b>Custom Routing Implementation</b><br /></p>

<br />


<p>In Sharp Architecture projects the custom routing instructions need to be added in the RouteRegistrar.cs file, located in the Web.Controllers assembly. Handily, the Sharp architecture example project had an example similar to what I was trying to achieve, so I just needed to tweak the area and route URL&rsquo;s to make my customer routing:<br /></p>

<br />




<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;font-size:12px;line-height:14px;overflow:auto;width:100%;padding:5px;"><code>    routes.CreateArea("Recipes", "RecipeBook.Web.Controllers.Recipes",
        routes.MapRoute(null, "Recipes/{controller}/{action}", new { action = "Index" }),
        routes.MapRoute(null, "Recipes/{controller}/{action}/{id}")
    );
</code></pre>




<br />


<p><b>Coding Tweaks<br />
</b><br /></p>

<br />


<p>An interesting result of this routing change was the tweaks that needed to be made to the code:<br /></p>

<ul><li>The action links in Views must now use the Html.ActionLinkForAreas() method instead of Html.ActionLink<i></i>()</li>
<li>RedirectToAction calls in controllers must include the controller name </li>
<li>Tests for Controller Actions, which redirect to another controller, should make use of the ToController(<i>controllerName</i>) MvcContrib TestHelper extension method.</li>
</ul>


<p><b>Revised controller signatures</b><br /></p>

<br />


<p>After implementing the custom routing the controllers and tests could be broken up into 4 separate files with the following method signatures:<br /></p>

<br />




<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;font-size:12px;line-height:14px;overflow:auto;width:100%;padding:5px;"><code>    interface IRecipesController    
    {
        ActionResult Index(string title);
    }
    interface ISummaryController    
    {
        ActionResult Edit(string recipeTitle);              
        ActionResult Edit(RecipeSummaryModel summaryModel); //Post        
    }
    interface IMethodController    
    {
        ActionResult Edit(string recipeTitle);
        ActionResult Edit(RecipeMethodModel methodModel);   //Post
    }
    interface IRecipeIngredientsController
    {
        ActionResult Edit(string recipeTitle);
        ActionResult AddRecipeIngredient(RecipeIngredientsModel ingredientsModel);  //Post
        ActionResult Edit(RecipeIngredientsModel ingredientsModel);                 //Post    
        ActionResult SearchIngredients(RecipeIngredientsModel ingredientsModel);    //Post
    }
</code></pre>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2009-08-27T20:24:00+01:00" data-updated="true" itemprop="datePublished">Aug 27<span>th</span>, 2009</time></div>
		<div class="tags">


	<a class='category' href='http://bakingwebsites.co.uk/blog/categories/software-design/'>Software Design</a>


</div>
		
			<span class="comments"><a href="http://bakingwebsites.co.uk/2009/08/27/preventing-dirty-domain-object-persistance/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="http://bakingwebsites.co.uk/2009/08/27/preventing-dirty-domain-object-persistance/" itemprop="url">Preventing Dirty Domain Object Persistance</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>The add recipes feature has currently been implemented in a way that does not allow for dirty domain objects to be persisted (saved to the database). The recipe object constructor must be passed all the essential object properties to prevent a partial object from being persisted, as shown below:<br /></p>

<br />




<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;font-size:12px;line-height:14px;overflow:auto;width:100%;padding:5px;"><code>        public Recipe(string title, IList recipeIngredients, string cookingMethod) : this()
        {
            //TODO - Add the recipe creator (ie. user) to the domain signature
            Check.Require(title != null &amp;&amp; title.Trim() != string.Empty, "title must be provided.");
            Check.Require(recipeIngredients != null, "recipeIngredients must be provided.");
            Check.Require(cookingMethod != null &amp;&amp; cookingMethod.Trim() != string.Empty, "method must be provided.");
            Title = title;
            Ingredients = recipeIngredients;
            CookingMethod = cookingMethod;        
        }
</code></pre>




<br />


<p>However this means that the state of the recipe object must be maintained across the 3 separate add recipe views. I&rsquo;ve had to use both hidden fields on the views and the TempDataDictionary to maintain this state. It has become clear to me that there may be a better way to implement this if I use a RecipeDraft domain object in addition to the Recipe object. However making this change will take a while so I need to weigh up whether I think it is worth while.<br /></p>

<br />


<p><b><span style="font-size:small;">Advantages</span></b><br /></p>

<ul><li>Users can add draft recipes and return later to complete them</li>
<li>More readable controller methods (RecipeIngredientDtos is a nasty object name!) <br />
</li>
<li>No need to maintain temporary state across views (using hidden fields and the TempDataDictionary)</li>
<li>Simplifed View Models</li>
</ul>


<p><b>Disadvantages</b><br /></p>

<ul><li>Time to refactor the code and unit tests</li>
<li>More records in the database (potentially higher cost)<br />
</li>
<li>More I/O operations on the database (slower website page loads)</li>
</ul>


<p>On balance I think the advantages are outweigh the disadvantages, so I will be refactoring the code to use a RecipeDraft object. This will be the constructor of the RecipeDraft object:<br /></p>

<br />




<pre style="background-color:#eeeeee;border:1px dashed rgb(153,153,153);color:black;font-family:Andale Mono, Lucida Console, Monaco, fixed, monospace;font-size:12px;line-height:14px;overflow:auto;width:100%;padding:5px;"><code>        public RecipeDraft(string title) : this()
        {
            //TODO - Add the recipe creator (ie. user) to the domain signature
            Check.Require(title != null &amp;&amp; title.Trim() != string.Empty, "title must be provided.");
            Title = title;      
        }
</code></pre>


		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="http://bakingwebsites.co.uk/blog/page/9/" class="prev">Prev</a>
    
    
        <a href="http://bakingwebsites.co.uk/blog/page/11/" class="next">Next</a>
    
    <div class="center"><a href="http://bakingwebsites.co.uk/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2015 - Hook Technologies Ltd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
			

<script type="text/javascript">
      var disqus_shortname = 'bakingwebsites';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





		</div>
	</div>
</body>
</html>
